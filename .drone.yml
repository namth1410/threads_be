kind: pipeline
type: kubernetes
name: build-push-and-update-infra

trigger:
  branch:
    - main
  event:
    - push

steps:
  # === B∆Ø·ªöC 0: DEBUG SECRETS ===
  - name: debug-secrets
    image: alpine
    environment:
      DOCKERHUB_USERNAME:
        from_secret: dockerhub_username
      DOCKERHUB_PASSWORD:
        from_secret: dockerhub_password
      GITHUB_TOKEN:
        from_secret: github_token
      IMAGE_REPO:
        from_secret: image_repo
      OVERLAY_PATH:
        from_secret: overlay_path
    commands:
      - echo "üîé Debug secrets..."
      - |
        if [ -z "$DOCKERHUB_USERNAME" ]; then
          echo "‚ùå DOCKERHUB_USERNAME is EMPTY";
        else
          echo "‚úÖ DOCKERHUB_USERNAME is set (length: ${#DOCKERHUB_USERNAME}, value: ${DOCKERHUB_USERNAME})";
        fi
        if [ -z "$DOCKERHUB_PASSWORD" ]; then
          echo "‚ùå DOCKERHUB_PASSWORD is EMPTY";
        else
          echo "‚úÖ DOCKERHUB_PASSWORD is set (length: ${#DOCKERHUB_PASSWORD}, first 4 chars: ${DOCKERHUB_PASSWORD:0:4})";
        fi
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "‚ùå GITHUB_TOKEN is EMPTY";
        else
          echo "‚úÖ GITHUB_TOKEN is set (length: ${#GITHUB_TOKEN}, first 4 chars: ${GITHUB_TOKEN:0:4})";
        fi
        echo "IMAGE_REPO=${IMAGE_REPO:-dangnam141002/threads-be}"
        echo "OVERLAY_PATH=${OVERLAY_PATH:-threads-infra/manifests/overlays/dev/api}"

  # === B∆Ø·ªöC 1: BUILD V√Ä PUSH IMAGE L√äN DOCKER HUB ===
  - name: build-and-push-to-dockerhub
    image: plugins/docker
    settings:
      repo: ${IMAGE_REPO}
      tags: 1.0.0-${DRONE_COMMIT_SHA:0:7}
      username:
        from_secret: dockerhub_username
      password:
        from_secret: dockerhub_password
      dockerfile: Dockerfile
      context: /drone/src
    environment:
      IMAGE_REPO:
        from_secret: image_repo
    depends_on:
      - debug-secrets

  # === B∆Ø·ªöC 2: C·∫¨P NH·∫¨T IMAGE TAG TRONG REPO INFRA ===
  - name: deploy
    image: line/kubectl-kustomize:1.31.0-5.7.1
    environment:
      REPO_URL:
        from_secret: repo_url
      IMAGE_REPO:
        from_secret: image_repo
      OVERLAY_PATH:
        from_secret: overlay_path
    commands:
      # 0. C√†i th√™m git v√¨ image n√†y kh√¥ng c√≥ s·∫µn
      - apk add --no-cache git

      # 1. C·∫•u h√¨nh th√¥ng tin ng∆∞·ªùi commit
      - git config --global user.name "namth1410"
      - git config --global user.email "tranhainam1410@gmail.com"

      # 2. Clone repo infra s·ª≠ d·ª•ng token
      - git clone $REPO_URL

      # 3. Di chuy·ªÉn v√†o ƒë√∫ng th∆∞ m·ª•c overlay c·∫ßn c·∫≠p nh·∫≠t
      - cd ${OVERLAY_PATH:-threads-infra/manifests/overlays/dev/api}

      # 4. D√πng kustomize ƒë·ªÉ c·∫≠p nh·∫≠t image tag m·ªõi
      - |
        IMAGE_REPO=${IMAGE_REPO:-dangnam141002/threads-be}
        kustomize edit set image ${IMAGE_REPO}:latest=${IMAGE_REPO}:1.0.0-${DRONE_COMMIT_SHA:0:7}

      # 5. Quay l·∫°i th∆∞ m·ª•c g·ªëc c·ªßa repo
      - cd ../../../../

      # 6. Add, commit v√† push thay ƒë·ªïi l√™n repo infra
      - git add .
      - 'git commit -m "ci: Update image for api to tag 1.0.0-${DRONE_COMMIT_SHA:0:7}"'

      - git remote set-url origin $REPO_URL
      - git push origin main
    depends_on:
      - build-and-push-to-dockerhub


